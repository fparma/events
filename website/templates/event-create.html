{% extends 'layout.html' %} {% block content %}
<div class="header"></div>
<div class="content" ng-app="fpEvents" ng-controller="eventsCtrl" ng-cloak>
    <h1 style="text-align: center">Create an event</h1>
    <select ng-model="missionType" ng-options="m.name for m in selectableMissionsTypes"></select>
    <input type="text" ng-model="missionSlots" size="2" placeholder="20" numbers-only="numbers-only" />
    <span>-</span>
    <input type="text" size="40" placeholder="Operation Name" ng-model="missionName" />
    <div style="margin-top: 1em">
        <span>Mission image:</span>
        <input type="file" name="missionImage" style="margin-left: 1em;" />
    </div>

    <div ng-show="missionSlots > 0 && missionName">
        <h2>[[missionType.name]][[missionSlots]] - [[missionName]]</h2>
        <h4>Mission description:</h4>
        <textarea style="height: 10em; width: 100%"></textarea>
        <div ng-controller="slotsCtrl">
            <h2>Slots</h2>
            <button type="button" ng-click="editManually()">Edit manually</button>
            <button type="button" disabled>Upload SQM file</button>
            <div ng-show="sideHasUnits('west') || sideHasUnits('east') || sideHasUnits('guer') || sideHasUnits('civ')">
                <span>Sides:</span>

                <span ng-repeat="side in orderedSides" style="font-size: 50%">
                    <input type="checkbox" ng-checked="sideHasUnits(side.sideName)" ng-click="updateSideSelection($event, side.sideName)" />
                    [[side.displayName]]
                </span>

                <div ng-repeat="side in orderedSides" ng-show="sideHasUnits(side.sideName)" style="width: 100%; clear: left">
                    <p style="margin-bottom: 0px">[[side.displayName]]</p>
                    <input type="text" placeholder="Group name" ng-model="newGrpName" />
                    <button type="button" ng-click="addNewGroup(side.sideName, newGrpName)">Add group</button>
                    <div ng-repeat="group in side.getGroups()" style="margin-top: 1em">
                        <div style="float: left; margin-right: 1.2em;">
                            <input type="text" value="[[group.name]]">
                            <div>
                                <button ng-click="addUnitToGroup(group)" ng-disabled="group.units.length >= 20">+</button>
                                <button ng-click="removeUnitFromGroup(group)" ng-disabled="group.units.length <= 1">-</button>
                                <button ng-click="deleteGroup(side.sideName, $index)">x</button>
                            </div>
                            <input type="text" style="display: block" ng-repeat="unit in group.units" placeholder="Unit [[$index+1]] description ">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} {% block tail %}
<script src="http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.3/angular.min.js "></script>
<script>
    angular.module('fpEvents', []).config(function ($interpolateProvider) {
        $interpolateProvider.startSymbol('[[');
        $interpolateProvider.endSymbol(']]');
    }).controller('eventsCtrl', ['$scope',
            function ($scope) {

            $scope.selectableMissionsTypes = [
                {
                    id: '1',
                    name: 'CO'
                    }, {
                    id: '2',
                    name: 'TvT'
                    }
                ];
            $scope.missionType = $scope.selectableMissionsTypes[0];


    }]).controller('slotsCtrl', ['$scope',
            function ($scope) {

            function resetSides() {
                $scope.sideSlots = {
                    west: [],
                    east: [],
                    guer: [],
                    civ: []
                };
            }
            resetSides();

            $scope.orderedSides = [
                {
                    getGroups: function () {
                        return $scope.sideSlots.west;
                    },
                    displayName: 'Blufor',
                    sideName: 'west'
                },
                {
                    getGroups: function () {
                        return $scope.sideSlots.east;
                    },
                    displayName: 'Opfor',
                    sideName: 'east'
                },
                {
                    getGroups: function () {
                        return $scope.sideSlots.guer;
                    },
                    displayName: 'Independent',
                    sideName: 'guer'
                },
                {
                    getGroups: function () {
                        return $scope.sideSlots.civ;
                    },
                    displayName: 'Civilian',
                    sideName: 'civ'
                },
            ];

            $scope.editManually = function () {
                resetSides();
                $scope.addSide('west');
            };

            $scope.updateSideSelection = function (e, side) {
                var isAdd = e.target.checked;
                if (isAdd) {
                    $scope.addSide(side);
                } else {
                    //remove
                    $scope.sideSlots[side] = [];
                }
            }

            $scope.addSide = function (side) {
                $scope.sideSlots[side].push({
                    name: 'Group',
                    side: side,
                    units: [{}, {}, {}, {}, {}, {}, {}, {}]
                });
            };

            $scope.sideHasUnits = function (side) {
                var slotSide = $scope.sideSlots[side];
                for (var key in slotSide) {
                    var units = slotSide[key].units;
                    if (units && units.length > 0) {
                        return true;
                    }
                }
                return false;
            };

            $scope.addNewGroup = function (side, name) {
                $scope.sideSlots[side].push({
                    name: name || 'Group',
                    side: side,
                    units: [{}, {}, {}, {}, {}, {}, {}, {}]
                });
            }
            $scope.deleteGroup = function (side, idx) {
                $scope.sideSlots[side].splice(idx, 1);
            };
            $scope.addUnitToGroup = function (group) {
                return group.units.push({});
            };
            $scope.removeUnitFromGroup = function (group) {
                return group.units.splice(group.length - 1, 1);
            };

        }]).directive('numbersOnly', function () {
        return {
            require: 'ngModel',
            restrict: 'A',
            link: function (scope, element, attrs, modelCtrl) {
                modelCtrl.$parsers.push(function (inputValue) {
                    if (inputValue == undefined) return ''
                    var transformedInput = Math.abs(inputValue.replace(/[^0-9+.]/g, '')) + '';
                    if (transformedInput.length > 2) {
                        transformedInput = (transformedInput[0] + transformedInput[1]);
                    }
                    if (transformedInput === '0') {
                        transformedInput = '';
                    }
                    if (transformedInput != inputValue) {
                        modelCtrl.$setViewValue(transformedInput);
                        modelCtrl.$render();
                    }

                    return transformedInput;
                });
            }
        };
    });
</script>
{% endblock %}
